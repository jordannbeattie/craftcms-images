{% import 'images/macros' as macros %}

{# Check image exists, has a value and that a transform has been specified #}
{% if (field is defined and field is not empty) and ((transform is defined and transform is not empty) or (mobileTransform is defined and mobileTransform is not empty))%}

	{% if field is instance of('craft\\elements\\Asset') %}
		{% set image = craft.assets.id(field.id).one() %}
	{% else %}
		{% set image = field.one() %}
	{% endif %}

	<picture {% if pictureClass is defined and pictureClass is not empty %}class="{{ pictureClass }}"{% endif %}>
		
        {# WebP #}
        {% if craft.app.images.supportsWebP and image.extension != "svg" %}
			
            {# Mobile #}
            {% if mobileTransform %}	
                {{ macros.src( image, mobileTransform, "sm", "webp", "image/webp" ) }}
            {% elseif transform %}
                {{ macros.src( image, transform, "sm", "webp", "image/webp" ) }}
			{% endif %}

            {# Desktop #}
			{% if transform %}
                {{ macros.src( image, transform, "lg", "webp", "image/webp" ) }}
			{% endif %}

		{% endif %}

        {# JPEG #}
        {% if image.extension != "svg" %}
        
            {# Mobile #}
            {% if mobileTransform %}
                {{ macros.src( image, mobileTransform, "sm", "jpg", "image/jpeg" ) }}
            {% elseif transform %}
                {{ macros.src( image, transform, "sm", "jpg", "image/jpeg" ) }}
            {% endif %}

            {# Desktop #}
            {% if transform %}
                {{ macros.src( image, transform, "lg", "jpg", "image/jpeg" ) }}
            {% endif %}

        {% endif %}

        {# Dimensions #}
        {% set width, height = null, null %}
        {% if dimensions ?? false %}
            {% if transform %}
                {% set width  = transform.width  %}
                {% set height = transform.height %}
            {% endif %}
            {% if attributes is defined and attributes is not empty %}
                {% set width  = attributes['width']  ?? width  %}
                {% set height = attributes['height'] ?? height %}
            {% endif %}
        {% endif %}
        
        
        {# Image Tag #}
		{{ macros.tag(
			(transform and image.extension != "svg") ? image.url(transform) : image.url,
			alt ?? image.title,
			class ?? null,
			style ?? null,
			attributes ?? null, 
			lazyLoading ?? true,
            width ?? null,
            height ?? null
		) }}

	</picture>

{# Output image without transform #}
{% elseif field is defined and field is not empty %}

	{% set image = (field is instance of('craft\\elements\\Asset'))
        ? craft.assets.id(field.id).one()
        : field.one() 
    %}

	{{ macros.tag(
		image.url,
		alt ?? image.title,
		class ?? null,
		style ?? null,
		attributes ?? null,
		lazyLoading ?? true,
        width ?? null, 
        height ?? null
	) }}

{# Output image tag with passed in image url #}
{% elseif fallback is defined and fallback is not empty %}

	{{ macros.tag(
		fallback,
		alt ?? null,
		class ?? null,
		style ?? null,
		attributes ?? null,
		lazyLoading ?? true,
        width ?? null, 
        height ?? null
	) }}

{# Report Error #}
{% else %}

	{{ macros.reportError("No image could be rendered. Check that you have passed an image and/or fallback.") }}

{% endif %}
