{% import 'images/macros' as macros %}

{# Check image exists, has a value and that a transform has been specified #}
{% if (field is defined and field is not empty) and ((transform is defined and transform is not empty) and (craft.images.transformExists(transform) or craft.images.mobileTransformExists(transform))) %}

	{% if field is instance of('craft\\elements\\Asset') %}
		{% set image = craft.assets.id(field.id).one() %}
	{% else %}
		{% set image = field.one() %}
	{% endif %}

	<picture>
		{% if craft.app.images.supportsWebP and image.extension != "svg" %}
			{% if craft.images.mobileTransformExists(transform) %}
				<source type="image/webp" media="(max-width: 599px)" srcset="{{ image.getUrl({
					transform: transform ~ 'Mobile',
					format: 'webp',
				}) }}">
			{% endif %}
			{% if craft.images.transformExists(transform) %}
				<source type="image/webp" media="(min-width: 600px)" srcset="{{ image.getUrl({
					transform: transform,
					format: 'webp',
				}) }}">
			{% endif %}
		{% endif %}
		{% if craft.images.mobileTransformExists(transform) %}
			<source media="(max-width: 599px)" srcset="{{ image.url(transform ~ 'Mobile') }}">
		{% endif %}
		{% if craft.images.transformExists(transform) %}
			<source media="(min-width: 600px)" srcset="{{ image.url(transform) }}">
		{% endif %}
		{{ macros.tag(
			craft.images.transformExists(transform) ? image.url(transform) : image.url,
			alt ?? null,
			class ?? null,
			style ?? null,
			attributes ?? null
		) }}
	</picture>

{# Output image without transform #}
{% elseif field is defined and field is not empty %}

	{{ macros.tag(
		(field is instance of('craft\\elements\\Asset')) ? craft.assets.id(field.id).one().url : field.one().url,
		alt ?? null,
		class ?? null,
		style ?? null,
		attributes ?? null
	) }}

{# Output image tag with passed in image url #}
{% elseif fallback is defined and fallback is not empty %}

	{{ macros.tag(
		fallback,
		alt ?? null,
		class ?? null,
		style ?? null,
		attributes ?? null
	) }}

{# Report Error #}
{% else %}

	{{ macros.reportError("No image could be rendered. Check that you have passed an image and/or fallback.") }}

{% endif %}

{# Error reporting #}
{% if (transform is defined) and (transform is not empty) and (not craft.images.transformExists(transform)) %}
	{{ macros.reportError("The transform does not exist.") }}
{% elseif (transform is defined) and (transform is not empty) and (not craft.images.mobileTransformExists(transform)) %}
	{{ macros.reportError("The mobile transform does not exist.") }}
{% endif %}
{# End Error reporting #}
